"use client";import{A as E,B as A,E as C,F as _,l as k,m as w,q as x,r as D,s as g,u as I,z as u}from"./chunk-CVDFGJFQ.mjs";import{C as y,Y as m,a as O,b as p,n as v,r as l,t as b,v as L,w as c}from"./chunk-VZ4W2FJS.mjs";import{c as R}from"./chunk-VAX7AB37.mjs";var U=R(O(),1);var N=r=>m(r),S=class{#e;#t;#i=null;#n=null;config={};#r=new Set;get instance(){return this.#i}constructor(t,i){this.#e=t,this.#t=i}setup(t){let{streamType:i}=this.#t.$state,e=p(i).includes("live"),s=p(i).includes("ll-");this.#i=new t({lowLatencyMode:s,backBufferLength:s?4:e?8:void 0,renderTextTracksNatively:!1,...this.config});let o=this.#h.bind(this);for(let n of Object.values(t.Events))this.#i.on(n,o);this.#i.on(t.Events.ERROR,this.#v.bind(this));for(let n of this.#r)n(this.#i);this.#t.player.dispatch("hls-instance",{detail:this.#i}),this.#i.attachMedia(this.#e),this.#i.on(t.Events.AUDIO_TRACK_SWITCHED,this.#l.bind(this)),this.#i.on(t.Events.LEVEL_SWITCHED,this.#u.bind(this)),this.#i.on(t.Events.LEVEL_LOADED,this.#f.bind(this)),this.#i.on(t.Events.LEVEL_UPDATED,this.#p.bind(this)),this.#i.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.#c.bind(this)),this.#i.on(t.Events.CUES_PARSED,this.#d.bind(this)),this.#t.qualities[E.enableAuto]=this.#g.bind(this),y(this.#t.qualities,"change",this.#E.bind(this)),y(this.#t.audioTracks,"change",this.#S.bind(this)),this.#n=L(this.#o.bind(this))}#s(t,i){return new c(N(t),{detail:i})}#o(){if(!this.#t.$state.live())return;let t=new A(this.#a.bind(this));return t.start(),t.stop.bind(t)}#a(){this.#t.$state.liveSyncPosition.set(this.#i?.liveSyncPosition??1/0)}#h(t,i){this.#t.player?.dispatch(this.#s(t,i))}#c(t,i){let e=this.#s(t,i),s=-1;for(let o=0;o<i.tracks.length;o++){let n=i.tracks[o],h=n.subtitleTrack??n.closedCaptions,d=new I({id:`hls-${n.kind}-${o}`,src:h?.url,label:n.label,language:h?.lang,kind:n.kind,default:n.default});d[g.readyState]=2,d[g.onModeChange]=()=>{d.mode==="showing"?(this.#i.subtitleTrack=o,s=o):s===o&&(this.#i.subtitleTrack=-1,s=-1)},this.#t.textTracks.add(d,e)}}#d(t,i){let e=this.#i?.subtitleTrack,s=this.#t.textTracks.getById(`hls-${i.type}-${e}`);if(!s)return;let o=this.#s(t,i);for(let n of i.cues)n.positionAlign="auto",s.addCue(n,o)}#l(t,i){let e=this.#t.audioTracks[i.id];if(e){let s=this.#s(t,i);this.#t.audioTracks[u.select](e,!0,s)}}#u(t,i){let e=this.#t.qualities[i.level];if(e){let s=this.#s(t,i);this.#t.qualities[u.select](e,!0,s)}}#p(t,i){i.details.totalduration>0&&this.#t.$state.inferredLiveDVRWindow.set(i.details.totalduration)}#f(t,i){if(this.#t.$state.canPlay())return;let{type:e,live:s,totalduration:o,targetduration:n}=i.details,h=this.#s(t,i);this.#t.notify("stream-type-change",s?e==="EVENT"&&Number.isFinite(o)&&n>=10?"live:dvr":"live":"on-demand",h),this.#t.notify("duration-change",o,h);let d=this.#i.media;this.#i.currentLevel===-1&&this.#t.qualities[E.setAuto](!0,h);for(let a of this.#i.audioTracks){let f={id:a.id.toString(),label:a.name,language:a.lang||"",kind:"main"};this.#t.audioTracks[u.add](f,h)}for(let a of this.#i.levels){let f={id:a.id?.toString()??a.height+"p",width:a.width,height:a.height,codec:a.codecSet,bitrate:a.bitrate};this.#t.qualities[u.add](f,h)}d.dispatchEvent(new c("canplay",{trigger:h}))}#v(t,i){if(i.fatal)switch(i.type){case"mediaError":this.#i?.recoverMediaError();break;default:this.#y(i.error);break}}#y(t){this.#t.notify("error",{message:t.message,code:1,error:t})}#g(){this.#i&&(this.#i.currentLevel=-1)}#E(){let{qualities:t}=this.#t;!this.#i||t.auto||(this.#i[t.switch+"Level"]=t.selectedIndex,k&&(this.#e.currentTime=this.#e.currentTime))}#S(){let{audioTracks:t}=this.#t;this.#i&&this.#i.audioTrack!==t.selectedIndex&&(this.#i.audioTrack=t.selectedIndex)}onInstance(t){return this.#r.add(t),()=>this.#r.delete(t)}loadSource(t){l(t.src)&&this.#i?.loadSource(t.src)}destroy(){this.#i?.destroy(),this.#i=null,this.#n?.(),this.#n=null}},T=class{#e;#t;#i;constructor(t,i,e){this.#e=t,this.#t=i,this.#i=e,this.#n()}async#n(){let t={onLoadStart:this.#r.bind(this),onLoaded:this.#s.bind(this),onLoadError:this.#o.bind(this)},i=await V(this.#e,t);if(v(i)&&!l(this.#e)&&(i=await P(this.#e,t)),!i)return null;if(!i.isSupported()){let e="[vidstack] `hls.js` is not supported in this environment";return this.#t.player.dispatch(new c("hls-unsupported")),this.#t.notify("error",{message:e,code:4}),null}return i}#r(){this.#t.player.dispatch(new c("hls-lib-load-start"))}#s(t){this.#t.player.dispatch(new c("hls-lib-loaded",{detail:t})),this.#i(t)}#o(t){let i=_(t);this.#t.player.dispatch(new c("hls-lib-load-error",{detail:i})),this.#t.notify("error",{message:i.message,code:4,error:i})}};async function P(r,t={}){if(!v(r)){if(t.onLoadStart?.(),r.prototype&&r.prototype!==Function)return t.onLoaded?.(r),r;try{let i=(await r())?.default;if(i&&i.isSupported)t.onLoaded?.(i);else throw Error("");return i}catch(i){t.onLoadError?.(i)}}}async function V(r,t={}){if(l(r)){t.onLoadStart?.();try{if(await D(r),!b(window.Hls))throw Error("");let i=window.Hls;return t.onLoaded?.(i),i}catch(i){t.onLoadError?.(i)}}}var q="https://cdn.jsdelivr.net",$=class extends C{$$PROVIDER_TYPE="HLS";#e=null;#t=new S(this.video,this.ctx);get ctor(){return this.#e}get instance(){return this.#t.instance}static supported=w();get type(){return"hls"}get canLiveSync(){return!0}#i=`${q}/npm/hls.js@^1.5.0/dist/hls.min.js`;get config(){return this.#t.config}set config(t){this.#t.config=t}get library(){return this.#i}set library(t){this.#i=t}preconnect(){l(this.#i)&&x(this.#i)}setup(){super.setup(),new T(this.#i,this.ctx,t=>{this.#e=t,this.#t.setup(t),this.ctx.notify("provider-setup",this);let i=p(this.ctx.$state.source);i&&this.loadSource(i)})}async loadSource(t,i){if(!l(t.src)){this.removeSource();return}this.media.preload=i||"",this.appendSource(t,"application/x-mpegurl"),this.#t.loadSource(t),this.currentSrc=t}onInstance(t){let i=this.#t.instance;return i&&t(i),this.#t.onInstance(t)}destroy(){this.#t.destroy()}};export{$ as HLSProvider};
//# sourceMappingURL=vidstack-BN7_0WI--M2S3JGGF.mjs.map